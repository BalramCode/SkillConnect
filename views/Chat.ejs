<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>SkillConnect - Dashboard</title>
  <style>
    /* Ensure HTML/Body are set up for full-height fixed layouts */
    html,
    body {
      height: 100%;
      overflow: hidden;
      /* Prevent body scroll, let the specific content area scroll */
    }

    /* This class forces the right content area to take up the remaining height and scroll */
    .content-area-wrapper {
      height: 100vh;
      overflow-y: auto;
    }

    .message {
      max-width: 60%;
      padding: 10px 14px;
      margin: 6px 0;
      border-radius: 18px;
      font-size: 14px;
      word-wrap: break-word;
    }

    .sent {
      background: #4f46e5;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .received {
      background: #e5e7eb;
      color: #111;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="flex h-screen bg-gray-50">
    <nav class="w-64 bg-white flex flex-col shadow-xl z-20 fixed h-full">
      <div class="flex gap-2 items-center p-5 border-b border-gray-100">
        <svg class="w-8 h-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <p class="text-indigo-800 font-extrabold text-2xl">SkillConnect</p>
      </div>

      <div class="mt-8 flex-grow overflow-y-auto">
        <ul class="flex flex-col gap-1 px-4 text-gray-700">
          <li class="group">
            <a class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300" href="/nav/dashboard">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 01-1 1h-3m-6 0a1 1 0001-1v-4a1 1 011-1h2a1 1 011 1v4a1 1 0001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>

          <li class="group">
            <a class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600"
              href="/nav/projects">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7a2 2 0 012-2h14a2 2 0 012 2M3 7h18" />
              </svg>
              Projects
            </a>
          </li>

          <li class="group">
            <a class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600"
              href="/nav/groups">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-3-3H5a3 3 0 00-3 3v2h5" />
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 12c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" />
              </svg>
              Groups
            </a>
          </li>

          <li class="group">
            <a class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600 bg-indigo-50 text-indigo-600 font-medium"
              href="/nav/chat">
              <svg
                  class="w-6 h-6"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 10h.01M12 10h.01M16 10h.01m-2 8l-4 4V18H6a2 2 0 01-2-2V6a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2h-4z"
                  />
                </svg>
              Chat
            </a>
          </li>

          <li class="group">
            <a class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600"
              href="/nav/profile">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z" />
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 14c-4.418 0-8 3.582-8 8h16c0-4.418-3.582-8-8-8z" />
              </svg>
              Profile
            </a>
          </li>

          <li class="group">
            <a class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300 hover:bg-indigo-50 hover:text-indigo-600"
              href="/nav/setting">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 01.073.431c.219 1.056 1.14 1.636 2.2 1.636h.273c1.072 0 2.053.7 2.207 1.745a.695.695 0 00.147.165l.659.659c.745.745 1.14 1.94 1.14 3.14s-.395 2.395-1.14 3.14l-.659.659c-.06.06-.11.12-.147.165c-.154 1.045-1.076 1.636-2.207 1.745h-.273c-1.06 0-1.981.58-2.2 1.636a1.724 1.724 0 01-.073.431c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 01-.073-.431c-.219-1.056-1.14-1.636-2.2-1.636h-.273c-1.072 0-2.053-.7-2.207-1.745a.695.695 0 00-.147-.165l-.659-.659c-.745-.745-1.14-1.94-1.14-3.14s.395-2.395 1.14-3.14l.659-.659c.06-.06.11-.12.147-.165c.154-1.045 1.076-1.636 2.207-1.745h.273c1.06 0 1.981-.58 2.2-1.636a1.724 1.724 0 01.073-.431z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 14a2 2 0 100-4 2 2 0 000 4z" />
              </svg>
              Setting
            </a>
          </li>
        </ul>
      </div>

      <div class="p-4 border-t border-gray-100">
        <a href="/nav/logout"
          class="flex items-center gap-3 p-3 text-lg rounded-lg transition-all duration-300 text-red-500 hover:bg-red-50 hover:text-red-700">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Logout
        </a>
      </div>
    </nav>

    <div class="flex-1 ml-64 content-area-wrapper">
      <nav
        class="bg-white sticky top-0 z-10 shadow-md flex justify-between p-4 items-center h-16 border-b border-gray-100">
        <div class="font-bold text-2xl text-gray-800 ml-6">Chat</div>

        <div class="relative w-96">
          <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 1114 0z" />
          </svg>
          <input
            class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
            type="text" placeholder="Search projects, teammates..." />
        </div>

        <div class="flex items-center gap-3 pr-6">
          <div
            class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-800 font-semibold">
            <% const fullName=user.fullname; const nameParts=fullName.split(' ').filter(part => part.length > 0); let initials
              = ''; if (nameParts.length === 1) { initials =
              nameParts[0].substring(0, 2).toUpperCase(); } else if
              (nameParts.length >= 2) { const firstNameInitial =
              nameParts[0].charAt(0); const lastNameInitial =
              nameParts[nameParts.length - 1].charAt(0); initials =
              (firstNameInitial + lastNameInitial).toUpperCase(); } %> <%=
              initials %>
            </div>
            <div class="flex flex-col justify-center">
              <p class="font-semibold text-gray-800 leading-none">
                <%= user.fullname %>
              </p>
              <p class="text-sm text-gray-500 leading-none mt-1">
                <%= user.university %>
              </p>
            </div>
          </div>
        </nav>
        <!-- Chatting Section -->
      <!-- Chatting Section -->
<div style="display:flex; height:80vh; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;">

  <!-- LEFT SIDEBAR -->
  <div style="width: 30%; min-width: 280px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; background: white;">
  <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
    <h2 style="margin: 0 0 15px 0; font-size: 20px; font-weight: 700;">Messages</h2>
    <input type="text" id="userSearch" placeholder="Search people..." onkeyup="searchUsers()"
      style="width: 100%; padding: 10px 15px; border-radius: 8px; border: 1px solid #e5e7eb; background: #f9fafb; outline: none;" />
  </div>
  
  <div id="searchResults" style="flex: 1; overflow-y: auto;"></div>
</div>

  <!-- RIGHT CHAT AREA -->
  <div style="width:70%; display:flex; flex-direction:column;">

    <!-- HEADER -->
    <div style="padding:15px; border-bottom:1px solid #e5e7eb; font-weight:600;" id="chatWith">
      Select or search a user to chat
    </div>

    <!-- MESSAGES -->
    <div id="messages" style="flex:1; padding:15px; overflow-y:auto; background:#f3f4f6;">
    </div>

    <!-- INPUT -->
    <div style="padding:10px; border-top:1px solid #e5e7eb; display:flex; gap:10px;">
      <input type="text" id="messageInput" placeholder="Type a message" onkeypress="handleKeyPress(event)"
        style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;" />
    
      <button onclick="sendMessage()"
        style="padding:10px 20px; border:none; border-radius:20px; background:#4f46e5; color:white;">
        Send
      </button>
    </div>

  </div>
</div>


    </div>

    
    <!-- For private chat script   -->
   <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      const currentUserId = "<%= user ? user._id : '' %>";

      let targetUserId = "";
      let joined = false;

      function joinChat() {
        targetUserId = document.getElementById("targetUserId").value.trim();

        if (!targetUserId) {
          alert("Enter user ID");
          return;
        }

        socket.emit("join-private", {
          userId: currentUserId,
          targetUserId: targetUserId
        });

        joined = true;

        document.getElementById("messages").innerHTML = "";
      }


      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (!message || !currentReceiverId) return;

        socket.emit("private-message", {
          senderId: currentUserId,
          receiverId: currentReceiverId,
          message: message
        });

        messageInput.value = ""; 
        
        // REFRESH SIDEBAR
        loadRecentChats(); 
      }


      socket.on("receive-private-message", (data) => {
          // 1. Refresh the sidebar list to show the person who just messaged you
          loadRecentChats();

          // 2. Display the message in the chat window IF that chat is currently open
          const msgBox = document.getElementById("messages");
          if (data.senderId === currentReceiverId || data.senderId === currentUserId) {
            if (msgBox.innerHTML.includes("Loading messages...") || msgBox.innerHTML.includes("No previous messages")) {
              msgBox.innerHTML = "";
            }
            displayMessage(data);
          }
        });

      async function searchUsers() {
       const query = document.getElementById("userSearch").value;

        // If the search box is empty, show Recent Chats again
        if (!query) {
          loadRecentChats();
          return;
        }

        const res = await fetch(`/search/search-users?q=${query}`);
        const users = await res.json();

        const resultsDiv = document.getElementById("searchResults");
        resultsDiv.innerHTML = "";

        users.forEach(user => {
          const div = document.createElement("div");
          div.textContent = user.username;
          div.style.cursor = "pointer";
          div.style.padding = "8px";
          div.style.borderBottom = "1px solid #eee";

          div.onclick = () => openChat(user._id, user.username);

          resultsDiv.appendChild(div);
        });
      }


      let currentReceiverId = null;
// Inside your <script> in the HTML file
      async function openChat(userId, username) {
        // 1. Clear the search input box
        document.getElementById("userSearch").value = "";
        
        // 2. Reload the recent chats list (this replaces the search results)
        loadRecentChats();
        currentReceiverId = userId;
        
        // Professional Header Update
        const chatHeader = document.getElementById("chatWith");
        chatHeader.style.background = "white";
        chatHeader.style.padding = "15px 20px";
        chatHeader.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 35px; height: 35px; border-radius: 50%; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-size: 14px;">
                ${username.charAt(0).toUpperCase()}
            </div>
            <span style="font-weight: 700; color: #111827;">${username}</span>
          </div>
        `;
        const msgBox = document.getElementById("messages");
        msgBox.innerHTML = "Loading messages..."; 

  try {
    // FIX: Changed path from /searchRouter/ to /search/
    const res = await fetch(`/search/get-messages/${currentUserId}/${userId}`);
    
    // Check if the response is actually OK (status 200)
    if (!res.ok) throw new Error('Server responded with ' + res.status);
    
    const history = await res.json();

    msgBox.innerHTML = ""; // Clear "Loading..."

    if (history && history.length > 0) {
      history.forEach(msg => {
        displayMessage(msg);
      });
    } else {
      msgBox.innerHTML = "<div style='text-align:center; color:#888; margin-top:20px;'>No previous messages</div>";
    }
    
    msgBox.scrollTop = msgBox.scrollHeight;
  } catch (err) {
    console.error("Fetch Error:", err);
    msgBox.innerHTML = "Error loading history. Check console.";
  }
          msgBox.scrollTop = msgBox.scrollHeight;

  socket.emit("join-private", { userId: currentUserId, targetUserId: userId });
}
      // Helper function to keep UI consistent
      function displayMessage(data) {
      const msgBox = document.getElementById("messages");
      const div = document.createElement("div");

      // Check if I sent this message
      // Note: Handle both database 'sender' and socket 'senderId' formats
      const senderId = data.sender?._id || data.sender || data.senderId;
      const isMe = senderId === currentUserId;

      div.style.display = "flex";
      div.style.justifyContent = isMe ? "flex-end" : "flex-start";
      div.style.marginBottom = "10px";

      div.innerHTML = `
        <div style="
          max-width: 70%; 
          padding: 8px 12px; 
          border-radius: 10px; 
          font-size: 14px;
          position: relative;
          box-shadow: 0 1px 1px rgba(0,0,0,0.1);
          background: ${isMe ? '#dcf8c6' : '#ffffff'}; 
          color: #303030;
          ${isMe ? 'border-top-right-radius: 0;' : 'border-top-left-radius: 0;'}
        ">
          ${data.message}
          <div style="font-size: 10px; color: #888; text-align: right; margin-top: 4px;">
            ${data.createdAt ? new Date(data.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now'}
          </div>
        </div>
      `;

      msgBox.appendChild(div);
      msgBox.scrollTop = msgBox.scrollHeight;
    }


    async function loadRecentChats() {
        try {
          const res = await fetch(`/search/recent-chats/${currentUserId}`);
          const users = await res.json();

          const resultsDiv = document.getElementById("searchResults");
          resultsDiv.innerHTML = ""; // Clear the sidebar
          // IF NO CHATS EXIST
              if (users.length === 0) {
                showEmptyState("No recent conversations");
                return;
              }
              
          users.forEach(user => {
            const div = document.createElement("div");
            
            // Truncate long messages so they don't break the UI
            const preview = user.lastMessage.length > 30 
              ? user.lastMessage.substring(0, 30) + "..." 
              : user.lastMessage;

            div.innerHTML = `
              <div style="display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                  onclick="openChat('${user._id}', '${user.username}')">
                
                <div style="width: 48px; height: 48px; border-radius: 50%; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">
                  ${user.username.charAt(0).toUpperCase()}
                </div>

                <div style="margin-left: 12px; flex: 1; min-width: 0;">
                  <div style="display: flex; justify-content: space-between; align-items: baseline;">
                    <div style="font-weight: 600; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      ${user.username}
                    </div>
                    <div style="font-size: 11px; color: #9ca3af; margin-left: 10px;">
                      ${user.lastTime || ""}
                    </div>
                  </div>
                  <div style="font-size: 13px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${preview}
                  </div>
                </div>
              </div>
            `;
            resultsDiv.appendChild(div);
          });
        } catch (err) {
          console.error("Error loading recent chats:", err);
        }
      }
      // This runs automatically when the page opens
      loadRecentChats();

      // Function that send msg when enter is pressed
      function handleKeyPress(event) {
        // Check if the pressed key is "Enter"
        if (event.key === "Enter") {
          event.preventDefault(); // Prevents the page from refreshing
          sendMessage();          // Calls your existing send function
        }
      }
      // Function that shows empty msg in chat when a new user is coming
      function showEmptyState(message) {
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; color: #9ca3af;">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 80px; height: 80px; margin-bottom: 20px; color: #e5e7eb;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <div style="font-weight: 500; font-size: 16px; color: #6b7280;">${message}</div>
          <p style="font-size: 13px; margin-top: 8px;">Search for users above to start a new conversation.</p>
        </div>
      `;
    }
    </script>


</body>

</html>